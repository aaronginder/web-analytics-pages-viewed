services:
  pubsub:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    ports:
      - "8085:8085"
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085 --project=local-project
    environment:
      - PUBSUB_PROJECT_ID=local-project
    volumes:
      - pubsub-data:/root/.config/gcloud/emulators/pubsub/
    healthcheck:
      test: ["CMD", "curl", "-f", "http://pubsub:8085"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s

  pubsub-setup:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
    depends_on:
      - pubsub
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub:8085
      - PUBSUB_PROJECT_ID=local-project
    command: >
      bash -c "
        echo 'Setting up PubSub emulator resources...' &&
        apt-get update && apt-get install -y curl &&
        echo 'Creating topic...' &&
        curl -X PUT http://pubsub:8085/v1/projects/local-project/topics/customer-notifications -H 'Content-Type: application/json' &&
        echo 'Creating subscription...' &&
        curl -X PUT http://pubsub:8085/v1/projects/local-project/subscriptions/customer-notifications-sub -H 'Content-Type: application/json' -d '{\"topic\":\"projects/local-project/topics/customer-notifications\",\"ackDeadlineSeconds\":10}' &&
        echo 'PubSub topics and subscriptions created.'
      "

  zookeeper:
    restart: always
    image: confluentinc/cp-zookeeper:latest
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper-data:/data/zookeeper       # Persistent volume for Zookeeper data (snapshots)
      - zookeeper-datalog:/data/zookeeper/datalog  # Persistent volume for transaction logs

  kafka:
    build:
      context: .
      dockerfile: ./docker/kafka/Dockerfile
    container_name: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9093,EXTERNAL://localhost:9092
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9093,EXTERNAL://0.0.0.0:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    depends_on:
      - zookeeper

  # transactions-producer:
  #   build:
  #     context: .
  #     dockerfile: ./producers/Dockerfile.transactions
  #   container_name: transactions-producer
  #   depends_on:
  #     - kafka
  #   environment:
  #     KAFKA_TOPIC: transactions
  #     KAFKA_BROKER: kafka:9093

  # beam-pipeline:
  #   build:
  #     context: ../consumers/customer-notifications
  #     dockerfile: Dockerfile
  #   depends_on:
  #     pubsub-setup:
  #       condition: service_completed_successfully
  #   environment:
  #     - PUBSUB_EMULATOR_HOST=pubsub:8085
  #     - PUBSUB_PROJECT_ID=local-project
  #   command: >
  #     java -jar /app/target/customer-notifications-1.0-SNAPSHOT.jar
  #     --runner=DirectRunner
  #     --subscription=projects/local-project/subscriptions/customer-notifications-sub
  #     --topicHost=pubsub-emulator:8085
  #     --debugMode=true

volumes:
  pubsub-data:
    driver: local
    name: pubsub-data

  zookeeper-data:
    name: zookeeper-data
    driver: local
  zookeeper-datalog:
    name: zookeeper-datalog
    driver: local
